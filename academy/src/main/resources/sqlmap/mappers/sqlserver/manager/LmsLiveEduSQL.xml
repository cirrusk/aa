<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="amway.com.academy.lms.liveedu.service.impl.LmsLiveEduMapper">
	
	<select id="selectLiveEduList" parameterType="reqBox" resultType="egovMap">
		/* LmsLiveEduSQL.xml -- selectLiveEduList - 라이브교육 시청 */
		SELECT TOP 1 
			B.COURSEID
		    , B.CATEGORYID
		    , (SELECT CATEGORYNAME FROM LMSCATEGORY WHERE CATEGORYID = B.CATEGORYID) AS CATEGORYNAME
		    , B.COURSETYPE
		    , B.OPENFLAG
		    , B.COURSENAME 
		    , B.COURSECONTENT 
		    , DBO.F_LMS_TIME_FORMAT(B.PLAYTIME, 'en') AS PLAYTIME 
		    , B.COURSEIMAGE
		    , B.COURSEIMAGENOTE
		    , B.SNSFLAG
		    , B.GROUPFLAG
     		, DBO.F_LMS_LIKECNT(B.LIKECOUNT, '1' ) AS LIKECNT
     		, DBO.F_LMS_LIKECNT(B.LIKECOUNT, '2' ) AS LIKECOUNT
     		, DBO.F_LMS_DATETYPE(B.STARTDATE, '3') AS MAINSTART
		    , DBO.F_LMS_DATETYPE(B.ENDDATE, '3') AS MAINEND
		    , DBO.F_LMS_DATETYPE(E.REPLAYSTART, '3') AS REPLAYSTART
		    , DBO.F_LMS_DATETYPE(E.REPLAYEND, '3') AS REPLAYEND
		    , E.LIVELINK
		    , E.LIVEREPLAYLINK
		    , E.LINKTITLE
		    , E.LINKURL
		    , CASE WHEN GETDATE() BETWEEN B.STARTDATE AND B.ENDDATE THEN 'Y' ELSE 'N' END AS MAINPLAYYN
		    , CASE WHEN GETDATE() BETWEEN E.REPLAYSTART AND E.REPLAYEND THEN 'Y' ELSE 'N' END AS REPLAYYN
		    , CASE WHEN GETDATE() BETWEEN DATEADD( MI, -30, B.STARTDATE) AND B.STARTDATE THEN 'Y' ELSE 'N' END AS PREMAINPLAYYN
		    , CASE WHEN GETDATE() BETWEEN DATEADD( MI, -30, E.REPLAYSTART) AND E.REPLAYSTART THEN 'Y' ELSE 'N' END AS PREREPLAYYN
		    , CASE WHEN GETDATE() BETWEEN E.REPLAYSTART AND E.REPLAYEND THEN 'Y' ELSE 'N' END AS PREREPLAYYN
		    , CASE WHEN ( (GETDATE() BETWEEN DATEADD( MI, -10, B.STARTDATE) AND B.ENDDATE) OR ( GETDATE() BETWEEN DATEADD( MI, -10, E.REPLAYSTART) AND E.REPLAYEND )  ) THEN 'Y' ELSE 'N' END AS INFOSHOWYN
		FROM LMSCOURSE B INNER JOIN LMSSTUDENT A
		ON B.COURSEID = A.COURSEID INNER JOIN LMSLIVE E
		ON A.COURSEID = E.COURSEID
		WHERE A.UID = #{uid}
		<if test='courseid != null and !courseid.equals("")'>
		AND A.COURSEID = #{courseid}	
		</if>
		AND A.REQUESTFLAG = 'Y'
		AND B.USEFLAG = 'Y'
		AND B.COURSETYPE = 'L'
		AND B.OPENFLAG != 'N'
		/*교육시간 30분전 부터 보여주기*/
		AND ( (GETDATE() BETWEEN DATEADD( MI, -30, B.STARTDATE) AND B.ENDDATE) OR ( GETDATE() BETWEEN DATEADD( MI, -30, E.REPLAYSTART) AND E.REPLAYEND ) )
		/*교육기간 중 또는 앞으로의 데이터 보여주는 경우*/
		/* AND (B.ENDDATE >=GETDATE() OR E.REPLAYEND >=GETDATE()) */
	    /*교육기간 데이터만 보여주는 경우*/
	    /*AND ( (GETDATE() BETWEEN B.STARTDATE AND B.ENDDATE ) OR (GETDATE() BETWEEN E.REPLAYSTART AND E.REPLAYEND) ) */
		ORDER BY 
		   /* 본방이 경우 0 아닌 경우 1을 줘서 정렬을 한다.*/
		CASE WHEN ( (GETDATE() BETWEEN E.REPLAYSTART AND E.REPLAYEND)  OR  (GETDATE() BETWEEN B.STARTDATE AND B.ENDDATE) ) THEN 0 ELSE 1 END ASC
		, CASE WHEN (GETDATE() BETWEEN DATEADD( MI, -30, E.REPLAYSTART) AND E.REPLAYEND) THEN E.REPLAYSTART ELSE B.STARTDATE END ASC  
		, A.COURSEID ASC
	</select>
	
</mapper>